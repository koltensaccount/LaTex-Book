% Counters synchronised with chapter numbering
\numberwithin{equation}{chapter}
\newcounter{textexample}[chapter]
\renewcommand{\thetextexample}{\thechapter.\arabic{textexample}}
\newcounter{theorem}[chapter]
\renewcommand{\thetheorem}{\thechapter.\arabic{theorem}}
\newcounter{definition}[chapter]
\renewcommand{\thedefinition}{\thechapter.\arabic{definition}}
\newcounter{marginfigure}[chapter]
\renewcommand{\themarginfigure}{\thechapter.\arabic{marginfigure}}

% Example environment styled with a margin banner
\newcommand{\solutiontag}{%
  \tikz[baseline=(s.base)] \node[fill=Accent,draw=none,
    text=Primary,font=\fontheader,rounded corners=2pt,
    inner xsep=6pt,inner ysep=2pt] (s) {Solution};%
}

\newenvironment{textexample}[1]{%
  \refstepcounter{textexample}%
  \Needspace*{5\baselineskip}%
  \vspace{0.6em}\noindent
  \makebox[0pt][l]{\hspace*{-1.2in}%
    \begin{tikzpicture}[baseline=(title.base)]
      \def\BW{1in}\def\BH{0.72cm}%
      \node[inner sep=0pt,minimum width=\BW,minimum height=\BH,
            anchor=base west,fill=Highlight,rounded corners=2pt] (box) at (0,0) {};%
      \node[font=\fontheader,text=white,anchor=center]
        at (box.center){Example~\thetextexample};%
      \coordinate (ruleStart) at (box.north west);%
      \coordinate (ruleEnd) at ($(ruleStart)+(\textwidth+1.2in,0)$);%
      \draw[RuleGray,line width=1pt](ruleStart)--(ruleEnd);%
      \node[font=\fontheader\large,text=Primary,
            anchor=base west,right=0.2in of box.east] (title) {#1};%
    \end{tikzpicture}%
  }%
  \par\vspace{0.8em}\noindent
}{\vspace{0.8em}}

% Theorem and definition box styling
\tcbset{
  chapterbox/.style={
    colback=Accent,
    colframe=Accent,
    fonttitle=\fontheader\color{Primary},
    boxrule=0pt,
    arc=2pt,
    left=10pt,right=10pt,top=6pt,bottom=6pt,
    enhanced,
  }
}

\newenvironment{theoremBox}[1]{%
  \refstepcounter{theorem}%
  \begin{tcolorbox}[chapterbox,
    title={THEOREM~\thetheorem\hspace{0.5em}\normalfont\itshape#1}]%
}{\end{tcolorbox}}

\newenvironment{definitionBox}[1]{%
  \refstepcounter{definition}%
  \begin{tcolorbox}[chapterbox,
    title={DEFINITION~\thedefinition\hspace{0.5em}\normalfont\itshape#1}]%
}{\end{tcolorbox}}

% Margin figure helper that aligns captions with numbering
\reversemarginpar
\newcommand{\MarginFigureAutoContent}[2]{%
  \begin{minipage}{\marginparwidth}
    \centering
    #1\\[2pt]
    {\fontcaption\textbf{\color{Primary}FIGURE~\themarginfigure.} #2}%
  \end{minipage}
}
\newcommand{\MarginFigureAuto}[3][0pt]{%
  \refstepcounter{marginfigure}%
  \vspace{#1}%
  \marginnote{\MarginFigureAutoContent{#2}{#3}}%
  \label{fig:\themarginfigure}%
}
